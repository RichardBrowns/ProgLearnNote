# 线程池

## 什么是线程池？

线程池是一种管理和复用线程的机制，用于提升并发程序的性能和效率。线程池通过维护一组预先创建的线程来处理任务，从而减少线程创建和销毁的开销。

## 线程池解决什么问题？

线程池解决的主要就是线程的管理问题。在并发环境下，程序需要执行的任务，需要调度的资源都是不确定的，线程池采用池化思想，就线程资源统一管理。

- 减少线程创建和销毁的开销
- 提升资源利用率
- 简化并发编程
- 控制并发数量，避免资源耗尽
- 任务调度与执行

## 线程池的总体设计？

Java中的线程池核心实现类是ThreadPoolExecutor，该类的继承关系如下。

<img src="https://p1.meituan.net/travelcube/912883e51327e0c7a9d753d11896326511272.png" alt="图1 ThreadPoolExecutor UML类图" style="zoom: 80%;" />

- Executor是顶层接口，它提供了一种将任务提交与任务执行分离的机制。用户只需提供Runnable对象，即将任务逻辑提交给Executor（执行器），由执行器来完成线程的调配和任务的执行。
- ExecutorService接口扩展了Executor接口
  - 提供管理线程池的方法，比如停止线程池的运行
  - 可以生成 Future 的方法来跟踪一个或多个异步任务的进度
- AbstractExecutorService提供 ExecutorService 接口的默认实现
- ThreadPoolExecutor结合这些特性，用于创建一个线程池，管理工作线程，控制任务的提交与执行。

ThreadPoolExecutor运行机制：

<img src="https://p0.meituan.net/travelcube/77441586f6b312a54264e3fcf5eebe2663494.png" alt="图2 ThreadPoolExecutor运行流程" style="zoom: 80%;" />

线程池的内部构造可以理解为一个生产者/消费者模型：

1. 生产者：
   - 角色：提交任务的客户端代码
   - 行为：创建任务（Runnable 或 Callable）并将其提交到线程池
2. 消费者：
   - 角色：线程池中的工作线程
   - 行为：从任务队列中获取任务并执行
3. 共享缓存区：
   - 角色：线程池内部的任务队列
   - 行为：存储等待执行的任务
4. 详细过程：
   - 生产过程：
     - 客户端代码（生产者）通过 execute() 或 submit() 方法提交任务
     - 如果有空闲线程，任务直接交给空闲线程执行
     - 如果没有空闲线程但未达到最大线程数，创建新线程执行任务
     - 如果线程数达到最大值，任务被放入队列（共享缓冲区）等待
   - 消费过程：
     - 工作线程（消费者）不断从任务队列中获取任务
     - 如果队列为空，线程进入等待状态
     - 获取到任务后，线程执行任务
     - 任务执行完毕后，线程再次尝试从队列获取新任务
   - 平衡机制：
     - 当任务提交速度快于执行速度时，队列会积累任务
     - 当队列满时，可能触发拒绝策略或创建新的线程（如果未达到最大线程数）
     - 当任务执行速度快于提交速度时，多余的线程会逐渐被回收（保留核心线程数）

## 线程池的生命周期？

线程池的运行状态，由线程池内部的变量来维护：是一个AtomicInteger类型，包含与运行状态（runState）与线程数量（workerCount）。32位数，前三位保存runState，后29位保存workerCount。

其生命周期包含以下阶段：

1. 创建阶段
   - 线程池被实例化，但还没有创建任何线程
   - 设置核心参数：核心线程数、最大线程数、keepAliveTime、工作队列等
   - 此时线程池处于 RUNNING 状态
2. 运行阶段（RUNNING）
   - 线程池接受新任务并处理排队的任务
   - 可以根据需求创建新的工作线程，直到达到最大线程数
   - 核心线程会一直存活，非核心线程在空闲超时后会被回收
3. 关闭阶段（SHUTDOWN）
   - 调用 shutdown() 方法进入此阶段
   - 不再接受新任务，但会继续处理已经提交的任务（包括队列中的任务）
   - 当所有任务执行完毕，线程池会进入 TIDYING 状态
4. 停止阶段（STOP）
   - 调用 shutdownNow() 方法进入此阶段
   - 尝试停止所有正在执行的任务
   - 不处理队列中尚未执行的任务
   - 返回未执行的任务列表
5. 整理阶段（TIDYING）
   - 所有任务都已终止，工作线程数量为0
   - 转换到此状态的线程会运行 terminated() 钩子方法
6. 终止阶段（TERMINATED）
   - 线程池彻底终止
   - terminated() 钩子方法执行完毕

生命周期状态转换：

- RUNNING -> SHUTDOWN: 调用 shutdown() 方法
- (RUNNING or SHUTDOWN) -> STOP: 调用 shutdownNow() 方法
- SHUTDOWN -> TIDYING: 当队列和线程池都为空
- STOP -> TIDYING: 当线程池为空
- TIDYING -> TERMINATED: 当 terminated() 钩子方法完成

